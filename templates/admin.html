{% extends "base.html" %}
{% block title %}Admin • Recipe Rumble{% endblock %}
{% block content %}
<div class="container">
  <h2 class="h3 fw-semibold text-accent mb-4">Admin Dashboard</h2>

  <ul class="nav nav-pills gap-2 mb-4 flex-wrap">
    <li class="nav-item"><a class="nav-link {% if active_tab=='post_recipe' %}active{% endif %}" href="{{ url_for('admin', tab='post_recipe') }}"><i class="fa-solid fa-plus me-1"></i> Post Recipe</a></li>
    <li class="nav-item"><a class="nav-link {% if active_tab=='view_submissions' %}active{% endif %}" href="{{ url_for('admin', tab='view_submissions') }}"><i class="fa-regular fa-images me-1"></i> View Submissions</a></li>
    <li class="nav-item"><a class="nav-link {% if active_tab=='manage_users' %}active{% endif %}" href="{{ url_for('admin', tab='manage_users') }}"><i class="fa-regular fa-user me-1"></i> Manage Users</a></li>
  </ul>

  {% if active_tab == 'post_recipe' %}
    {% if active_recipe %}
      <div class="alert alert-info d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>An active recipe is currently posted: <strong>{{ active_recipe['title'] }}</strong></div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('edit_recipe', recipe_id=active_recipe['id']) }}" class="btn btn-outline-secondary btn-sm">
            <i class="fa-regular fa-pen-to-square me-1"></i> Edit
          </a>
          <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
            <i class="fa-regular fa-trash-can me-1"></i> Delete
          </button>
        </div>
      </div>

      <!-- Confirm Delete Modal -->
      <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content rounded-xxl">
            <div class="modal-header">
              <h5 class="modal-title text-danger"><i class="fa-regular fa-triangle-exclamation me-2"></i> Delete recipe?</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="mb-2">This will permanently remove the current recipe and all associated submissions and votes.</p>
              <p class="mb-0"><strong>Recipe:</strong> {{ active_recipe['title'] }}</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <a href="{{ url_for('delete_recipe', recipe_id=active_recipe['id']) }}" class="btn btn-danger">
                Delete recipe
              </a>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="card card-foody">
        <div class="card-body">
          <h3 class="h5 mb-3">Post New Recipe</h3>
          <form method="post" enctype="multipart/form-data" action="{{ url_for('admin', tab='post_recipe') }}">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Title</label>
                <input type="text" name="title" required class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Image (optional)</label>
                <input type="file" name="image" accept="image/png, image/jpeg" class="form-control" id="postImage">
              </div>
              <div class="col-md-6">
                <label class="form-label">Ingredients</label>
                <textarea name="ingredients" required class="form-control" rows="4"></textarea>
              </div>
              <div class="col-md-6">
                <label class="form-label">Instructions</label>
                <textarea name="instructions" required class="form-control" rows="4"></textarea>
              </div>
              <div class="col-12 d-grid d-md-inline">
                <button class="btn btn-accent-gradient px-4" type="submit">Post Recipe</button>
              </div>
            </div>
          </form>
          <hr class="my-4">
          <h4 class="h5 mb-3">Live Preview</h4>
          <div class="row g-4 align-items-start" id="adminPreview" style="display:none">
            <div class="col-md-5">
              <div class="ratio ratio-4x3 rounded-xxl overflow-hidden bg-secondary-subtle">
                <img id="previewImage" class="w-100 h-100 img-cover admin-recipe-img" alt="Recipe preview" style="display:none">
              </div>
            </div>
            <div class="col-md-7">
              <h5 class="fw-semibold mb-3" id="previewTitle">Recipe title</h5>
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="card h-100 border-0 shadow-sm rounded-xxl">
                    <div class="card-body">
                      <h6 class="text-uppercase text-secondary mb-2">Ingredients</h6>
                      <ul id="previewIngredients" class="list-unstyled mb-0 small">
                        <li class="text-secondary">Type ingredients—one per line</li>
                      </ul>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100 border-0 shadow-sm rounded-xxl">
                    <div class="card-body">
                      <h6 class="text-uppercase text-secondary mb-2">Instructions</h6>
                      <ol id="previewInstructions" class="mb-0 small ps-3">
                        <li class="text-secondary">Type instructions—one step per line</li>
                      </ol>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% elif active_tab == 'view_submissions' %}
    <div class="row g-4">
      {% for submission in submissions %}
      <div class="col-sm-6 col-lg-4">
        <div class="card card-foody h-100">
          {% if submission['image_base64'] %}
            <img src="data:image/jpeg;base64,{{ submission['image_base64'] }}" class="card-img-top" style="height:220px;object-fit:cover" alt="Submission {{ submission['submission_id'] }}">
          {% endif %}
          <div class="card-body">
            <h6 class="text-secondary">ID: {{ submission['submission_id'] }}</h6>
            <p class="mb-1"><small><strong>Recipe:</strong> {{ submission['title'] }}</small></p>
            <p class="mb-1"><small><strong>User:</strong> {{ submission['username'] }}</small></p>
            <p class="mb-0"><small><strong>Submitted:</strong> {{ submission['submitted_at'] }}</small></p>
          </div>
        </div>
      </div>
      {% endfor %}
      {% if not submissions %}
      <div class="col-12"><p class="text-muted">No submissions yet.</p></div>
      {% endif %}
    </div>
  {% elif active_tab == 'manage_users' %}
    <div class="card card-foody">
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="table-light">
            <tr><th>Username</th><th>Role</th><th>Points</th></tr>
          </thead>
          <tbody>
            {% for u in users %}
            <tr><td>{{ u['username'] }}</td><td>{{ u['role'] }}</td><td>{{ u['points'] }}</td></tr>
            {% endfor %}
            {% if not users %}
            <tr><td colspan="3" class="text-center text-muted">No users found.</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Elements
  const titleEl = document.querySelector('input[name="title"]');
  const ingEl = document.querySelector('textarea[name="ingredients"]');
  const instEl = document.querySelector('textarea[name="instructions"]');
  const fileEl = document.querySelector('#postImage');
  const previewWrap = document.getElementById('adminPreview');
  const previewTitle = document.getElementById('previewTitle');
  const prevImg = document.getElementById('previewImage');
  const prevIngredients = document.getElementById('previewIngredients');
  const prevInstructions = document.getElementById('previewInstructions');

  function toList(text){
    return (text || '').split('\n').map(s => s.trim()).filter(Boolean);
  }
  function renderList(list, ul, ordered){
    ul.innerHTML = '';
    if(!list.length){
      const li = document.createElement(ordered ? 'li' : 'li');
      li.className = 'text-secondary';
      li.textContent = ordered ? 'Type instructions—one step per line' : 'Type ingredients—one per line';
      ul.appendChild(li);
      return;
    }
    list.forEach(item => {
      const li = document.createElement(ordered ? 'li' : 'li');
      li.textContent = item;
      ul.appendChild(li);
    });
  }

  function updatePreview(){
    previewWrap.style.display = 'block';
    previewTitle.textContent = titleEl?.value || 'Recipe title';
    renderList(toList(ingEl?.value), prevIngredients, false);
    renderList(toList(instEl?.value), prevInstructions, true);
    // Auto-height: match image height to the tallest of the two cards
    requestAnimationFrame(() => {
      try {
        const ingCard = prevIngredients.closest('.card');
        const instCard = prevInstructions.closest('.card');
        const maxH = Math.max(ingCard?.offsetHeight || 0, instCard?.offsetHeight || 0);
        if(maxH > 0){
          // On md+ we want the image to match; on small screens let it be natural
          if(window.matchMedia('(min-width: 768px)').matches){
            prevImg.style.display = prevImg.src ? 'block' : 'none';
            prevImg.style.height = maxH + 'px';
            prevImg.style.objectFit = 'cover';
          }else{
            prevImg.style.height = '';
          }
        }
      } catch(e){ /* no-op */ }
    });
  }

  // File preview + accept check already enforced by accept attribute; add runtime check
  fileEl?.addEventListener('change', function(){
    const f = this.files && this.files[0];
    if(!f) return;
    const ok = (f.type === 'image/png') || (f.type === 'image/jpeg');
    if(!ok){
      alert('Please upload a PNG or JPEG image.');
      this.value = '';
      prevImg.removeAttribute('src');
      prevImg.style.display = 'none';
      return;
    }
    const reader = new FileReader();
    reader.onload = (e) => {
      prevImg.src = e.target.result;
      prevImg.style.display = 'block';
      updatePreview();
    };
    reader.readAsDataURL(f);
  });

  ['input','change'].forEach(ev => {
    titleEl?.addEventListener(ev, updatePreview);
    ingEl?.addEventListener(ev, updatePreview);
    instEl?.addEventListener(ev, updatePreview);
  });

  window.addEventListener('resize', updatePreview);
})();
</script>
{% endblock %}
