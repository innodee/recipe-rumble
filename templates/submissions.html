{% extends "base.html" %}
{% block title %}Submissions • Recipe Rumble{% endblock %}
{% block content %}
<div class="container">
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
    <h2 class="h3 fw-semibold text-accent mb-0">Hello, {{ user['username'] }}</h2>
    <span class="text-secondary small">Points: <strong>{{ user['points'] }}</strong></span>
  </div>

  <div class="d-flex align-items-center gap-2 mb-3">
    <h3 class="h4 mb-0">Submissions{% if recipe %} for <span class="text-accent">{{ recipe['title'] }}</span>{% endif %}</h3>
    {% if recipe and status != 'inactive' %}
      <span id="timer" class="badge badge-soft ms-2 px-3 py-2">Loading…</span>
    {% endif %}
  </div>

  {% if recipe and status != 'inactive' %}
    {% if user_voted %}
      <div class="alert alert-success"><i class="fa-regular fa-circle-check me-1"></i> You have already voted for this recipe.</div>
    {% elif user['role'] == 'admin' %}
      <div class="alert alert-warning"><i class="fa-solid fa-triangle-exclamation me-1"></i> Admins cannot vote.</div>
    {% endif %}

    <div id="submissions-container" class="row g-4">
      {% for submission in submissions %}
      <div class="col-sm-6 col-lg-4">
        <div class="card card-foody h-100 hover-raise">
          {% if submission['image_base64'] %}
          <img src="data:image/jpeg;base64,{{ submission['image_base64'] }}" class="card-img-top" style="height:240px;object-fit:cover" alt="Submission {{ submission['submission_id'] }}">
          {% else %}
          <div class="bg-secondary-subtle d-flex align-items-center justify-content-center" style="height:240px;"><span class="text-secondary">No image</span></div>
          {% endif %}
          <div class="card-body d-flex flex-column">
            <p class="text-muted small mb-3">ID: {{ submission['submission_id'] }}</p>
            {% if not user_voted and user['role'] != 'admin' %}
              <div class="mt-auto">
                {% if status == 'voting' %}
                <a href="{{ url_for('vote', submission_id=submission['submission_id']) }}" class="btn btn-accent-gradient w-100"><i class="fa-regular fa-thumbs-up me-1"></i> Vote</a>
                {% else %}
                <button class="btn btn-outline-secondary w-100" disabled>Vote (during voting period)</button>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="col-12"><p class="text-muted">No submissions yet for this recipe.</p></div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">No active recipe or submission period is not active.</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if recipe and status != 'inactive' %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  const timerEl = document.getElementById('timer');
  const initialTimeLeft = {{ time_left|int }};
  const start = Date.now();
  function fmt(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const d = Math.floor(s/86400);
    const h = Math.floor((s%86400)/3600);
    const m = Math.floor((s%3600)/60);
    const sec = s%60;
    return `${d}d ${h}h ${m}m ${sec}s`;
  }
  function tick(){
    const elapsed = Date.now() - start;
    const left = Math.max(0, initialTimeLeft - elapsed);
    timerEl.textContent = `{{ 'Submission' if status=='submission' else 'Voting' }} ends in ${fmt(left)}`;
    if(left>0) requestAnimationFrame(tick);
    else {
      document.getElementById('submissions-container')?.classList.add('d-none');
      timerEl.textContent = '{{ 'Submission' if status=='submission' else 'Voting' }} period ended';
    }
  }
  tick();
});
</script>
{% endif %}
{% endblock %}
